$loc = Get-AzureRmLocation | OGV -passthru | select Location #first set a location
$RGname = Get-AzureRmResourceGroup | ? Location -Contains $location.Location | OGV -PassThru | select ResourceGroupName
$Node = Get-AzureRmVM | ? ResourceGroupName -Contains $RGname.ResourceGroupName | OGV -PassThru | select Name
$Pip = Get-AzureRmPublicIpAddress -ResourceGroupName $RGname.ResourceGroupName | select Name,IpAddress,PublicIpAllocationMethod | OGV -PassThru
$TestObj = New-Object PSObject -Property @{

VMName = $Node.Name
IPAllocation = $pip.PublicIpAllocationMethod
PublicIP = $pip.IpAddress

}

# Use this (-SettingString ) for simple setup
$SettingsString = ‘{ “AntimalwareEnabled”: true,”RealtimeProtectionEnabled”: true}’;
 
# Use this (-SettingString ) to configure from json file
$MSAVConfigfile = Get-Content 'C:\Users\bprescott\Documents\Clients\Chamberlain\Azure Scripts\ACTIVE\VM-AntiMalware.json' -Raw
 
$allVersions= (Get-AzureRmVMExtensionImage -Location $location -PublisherName “Microsoft.Azure.Security” -Type “IaaSAntimalware”).Version
$typeHandlerVer = $allVersions[($allVersions.count)–1]
$typeHandlerVerMjandMn = $typeHandlerVer.split(“.”)
$typeHandlerVerMjandMn = $typeHandlerVerMjandMn[0] + “.” + $typeHandlerVerMjandMn[1]
$SettingsString = ‘{ “AntimalwareEnabled”: true}’;
 
# Specify for -SettingString parameter here which option you want, simple $settingsstring or $MSAVConfigfile to sue json file.
$vmName = Get-AzureRmVM -ResourceGroupName $RGname 

foreach ($hostVM in $vmName.Name) {

Set-AzureRmVMExtension -ResourceGroupName $RGname -VMName $vmName -Name “IaaSAntimalware” -Publisher “Microsoft.Azure.Security” -ExtensionType “IaaSAntimalware” -TypeHandlerVersion $typeHandlerVerMjandMn -SettingString $SettingsString -Location $location

}